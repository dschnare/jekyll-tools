# Jekyll Combiner

Latest stable version: `1.1.3`  
Last updated: `Sep 04, 2012`

Author: Mathieu Bouchard | [matb33.me](http://www.matb33.me/) | [@matb33](http://twitter.com/matb33)

## What is it?

Jekyll Combiner is a [Jekyll](http://jekyllrb.com/)
[plugin](https://github.com/mojombo/jekyll/wiki/Plugins) that allows compiling
[LESS](http://lesscss.org/) and combining and/or minifying JS files, as well as
allowing arbitrary file copying.

This combiner is ideal for use with
[Twitter Bootstrap](http://twitter.github.com/bootstrap/). The example below
outlines a very basic Jekyll setup that is well integrated with Bootstrap,
allowing control over its LESS variables and allowing you to use Bootstrap
mixins -- all without touching the Bootstrap core.

## Getting Started

A typical Jekyll file and folder structure could look like the following. Adapt
as you see fit for your own style:

	_assets
	|__ lessjs
	|__ twitter-bootstrap-320b75d
	_includes
	|__ gen
	|	|__ (empty)
	_layouts
	|__ default.html
	_plugins
	|__ combiner.rb
	less
	|__ main.less
	js
	|__ main.js
	gen
	|__ (empty)
	|
	Gemfile
	Rakefile
	_config.yml
	index.html

-	The `_assets` folder will hold various assets that are not meant to be
	published directly:
	1.	The [lessjs](https://github.com/cloudhead/less.js) compiler, as-is;
	2.	The [bootstrap](https://github.com/twitter/bootstrap) source, as-is.

-	The `_includes` folder, part of Jekyll. We are adding the extra `gen`
	sub-folder to hold generated files. Specifically, we store the current
	*md5 hash* values of the latest CSS and JS output files.

-	The `_layouts` folder, part of Jekyll. A really basic example base layout
	could look like the following:

		---
		---
		<!DOCTYPE html>
		<html>
			<head>
				<link href="/gen/{% include gen/css.hash %}.min.css" rel="stylesheet" type="text/css" media="all" />
				<script type="text/javascript" src="/gen/{% include gen/js.hash %}.min.js"></script>
			</head>
			<body>
				{{ content }}
			</body>
		</html>

	Notice the Liquid include of the generated hash values. You'll see how this
	is defined later on in `_config.yml`.

-	The `_plugins` folder holds the `combiner.rb` file, which is our plugin.

-	The `less` folder holds our website's LESS stylesheets. An example
	`main.less`:

		@import "bootstrap";
		@import "responsive";

		@iconSpritePath: "../gen/glyphicons-halflings.png";
		@iconWhiteSpritePath: "../gen/glyphicons-halflings-white.png";

	It's important to note that we are doing our own `@import` statements to
	bring in all additional LESS stylesheets outside of `main.less`.

	Equally important is to note that we can override Bootstrap variables *very*
	easily!

-	The `js` folder holds our website's JS scripts.

-	The `gen` folder is where we've decided to output files generated by the
	combiner.

-	The `Gemfile` could look like the following:

		source "http://rubygems.org"

		gem 'jekyll'
		gem 'liquid'
		gem 'rake'
		gem 'uglifier'

-	The `Rakefile` could look like the following:

		begin
			require 'rubygems'
			require 'bundler'
		rescue LoadError
			raise "Could not load the bundler gem. Install it with `gem install bundler`."
		end

		begin
			Bundler.setup
		rescue Bundler::GemNotFound
			raise RuntimeError, "Bundler couldn't find some gems. Did you run `bundle install`?"
		end

		task :default => :server

		desc 'Build site with Jekyll'
		task :build do
		    jekyll
		end

		desc 'Build and start server with --auto'
		task :server do
			jekyll '--server --auto'
		end

		def is_windows
			return true if RUBY_PLATFORM.downcase.include? 'mswin'
			return true if RUBY_PLATFORM.downcase.include? 'mingw'
			return false if RUBY_PLATFORM.downcase.include? 'darwin'
			return false if RUBY_PLATFORM.downcase.include? 'linux'
			return false
		end

		def jekyll(opts = '')
			if is_windows
				sh 'chcp 65001'
				sh 'if exist _site rd /s /q _site'
				sh 'if exist _site rd /s /q _includes/gen'
				sh 'if exist _site rd /s /q gen'
			else
				sh 'rm -rf _site'
				sh 'rm -rf _includes/gen'
				sh 'rm -rf gen'
			end
			sh 'jekyll ' + opts
		end

	When developing, you'd simply have to type `rake`, then head on over to
	http://localhost:4000/

-	The `_config.yml` could look like the following:

		exclude: ['_tmp', '_assets', 'Rakefile', 'Gemfile', 'Gemfile.lock']
		combiner:
		  tmp: _tmp
		  silent: true
		  less:
		    command: 'node _assets/lessjs/bin/lessc --compress --include-path=:tmp -'
		    compile:
		    - in: ['_assets/twitter-bootstrap-320b75d/less/*.less', 'less/*.less']
		      out: 'gen/:hash.min.css'
		      hash: '_includes/gen/css.hash'
		      root: 'main.less'
		  js:
		    combine:
		    - in:
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-affix.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-alert.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-button.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-carousel.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-collapse.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-dropdown.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-modal.js'
		      # Notice that tooltip comes before popover
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-tooltip.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-popover.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-scrollspy.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-tab.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-transition.js'
		      - '_assets/twitter-bootstrap-320b75d/js/bootstrap-typeahead.js'
		      - 'js/main.js'
		      out: 'gen/:hash.min.js'
		      hash: '_includes/gen/js.hash'
		      uglify: true
		  copy:
		  - in: '_assets/twitter-bootstrap-320b75d/img/*.png'
		    out: 'gen'

	**Notice the `hash:` key in both the `less:` and `js:` config trees, and
	the associated `:hash` token in the `out:` key.** The MD5 hash of the final
	output file is calculated and the `:hash` token in `out:` is replaced with
	this MD5 hash. Then, this same MD5 hash is written to the file specified in
	`hash:`. This allows you to use a Liquid include to rebuild the path for
	the CSS and JS final output files.

	**Notice the `root:` key in the less compile.** The combiner plugin does not
	do any combining for LESS files. It's left up to you to do `@import`
	statements within the file specified as being `root:`. The LESS compiler
	will inherently combine when importing.

	This is possible because all files specified by `in:` are copied to the same
	temporary folder specified by `tmp:`. Your `@import` statements should then
	include based on the knowledge that all LESS files are in the same folder
	together.

-	And finally, an example `index.html` to complete the picture:

		---
		layout: default
		title: "Home"
		---
		<h1>{{ page.title }}</h1>
		<p>Hello world!</p>

So basically, the flow goes like this:

1.	Combiner copies all LESS files to a temporary directory;
2.	Combiner invokes LESS compiler on the root LESS file;
3.	Combiner writes resulting CSS to output file;
4.	If using a hash token in the output filename, writes the hash value to the
	specified file;
5.	Combiner combines all JS files into memory;
6.	Combiner optionally uglifies JS;
7.	Combiner writes resulting JS to output file;
8.	If using a hash token in the output filename, writes the hash value to the
	specified file;
9.	Combiner copies files in `copy:`, such as images from a library.

## Configuration options

### Global options

**tmp:** Specify a temporary folder for the combiner to use as required.

**silent:** Set to true to show only fatal errors, otherwise be verbose.

### LESS options (`less:`)

**command:** Specify the command to run to compile LESS files. The example in
this documentation assumes the use of the less.js compiler. In that instance,
NodeJS will need to be installed to invoke it.

In theory, another compiler implementation could be used. It must take input via
STDIN and send output to STDOUT. The `:tmp` token is replaced with the
temporary directory specified by `tmp:`.

**compile:** Allows you to specify one or more compile actions. Each of these
actions consist of the following keys:

**in:** Glob pattern or array of glob patterns of files to copy to the
temporary directory specified by `tmp:`.

**not:** *Optional.* Simple exclusion pattern or array of patterns to run
against the file list collected by `in:` (partial text match).

**out:** The output file for the compiled CSS styles. The optional `:hash`
token can be specified anywhere in the filename, and will be replaced with the
MD5 hash value of the contents of the compiled CSS.

**hash:** *Optional.* Write the computed MD5 hash value of the compiled CSS to
this file. It is recommended to write it somewhere within the `_includes` folder
so as to be able to `{% include %}` it in your `<style>` tag.

**root:** The combiner plugin doesn't actually combine LESS files, instead
deferring this responsibility to the LESS compiler and the file specified in
this configuration option. It is the role of the `root:` file to `@import` other
LESS files.

*Remember: All LESS files matched by `in:` are copied to a temporary directory
where `@import` statements can read them in as siblings.*

### JS options (`js:`)

**combine:** Allows you to specify one or more combine actions. Each of these
actions consist of the following keys:

**in:** Glob pattern or array of glob patterns of files to combine.

**not:** *Optional.* Simple exclusion pattern or array of patterns to run
against the file list collected by `in:` (partial text match).

**out:** The output file for the combined/uglified JS. The optional `:hash`
token can be specified anywhere in the filename, and will be replaced with the
MD5 hash value of the contents of the combined/uglified JS.

**hash:** *Optional.* Write the computed MD5 hash value of the compiled CSS to
this file. It is recommended to write it somewhere within the `_includes` folder
so as to be able to `{% include %}` it in your `<script>` tag.

**uglify:** Whether or not to uglify (minify/compress) the JS code.

### Copy options (`copy:`)

**copy:** Allows you to specify one or more copying actions. Each of these
actions consist of the following keys:

**in:** Glob pattern or array of glob patterns of files to copy.

**not:** *Optional.* Simple exclusion pattern or array of patterns to run
against the file list collected by `in:` (partial text match).

**out:** Destination folder for files being copied.

## TODO / Ideas:

- 	Consider iterating over the top level config keys in _config.yml and execute
	in that order. We could then do some copy operations beforehand, and then
	afterwards too. This came up with regards to a more solid FontAwesome
	integration flow

## Copyright and license

> Copyright 2012 Mathieu Bouchard

> Licensed under the Apache License, Version 2.0 (the "License");
> you may not use this work except in compliance with the License.
> You may obtain a copy of the License in the LICENSE file, or at:

>     http://www.apache.org/licenses/LICENSE-2.0

> Unless required by applicable law or agreed to in writing, software
> distributed under the License is distributed on an "AS IS" BASIS,
> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
> See the License for the specific language governing permissions and
> limitations under the License.